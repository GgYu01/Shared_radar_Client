# 修改范围：整文件替换（Windows 本机聚合，按 Upgrade 头分流）
worker_processes  1;

events { worker_connections  1024; }

http {
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout  65;

  # debug-friendly access log (包含 upstream 与 upgrade 关键信息)
  log_format agg '$remote_addr - $remote_user [$time_local] '
                 '"$request" $status $body_bytes_sent '
                 '"$http_referer" "$http_user_agent" '
                 'upstream=$upstream_addr ustatus=$upstream_status '
                 'upgrade="$http_upgrade"';
  access_log  logs/access.log agg;

  # map: 生成 Connection 头（WS 需要 upgrade，其它走 close）
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  # map: 基于 Upgrade 头选择后端（WS->9001，其它->9002）
  map $http_upgrade $backend {
    default     "127.0.0.1:9002";  # default: UI (Kestrel)
    ~*^websocket$   "127.0.0.1:9001";  # 任意大小写的 "websocket" 都走数据端
  }

  # 如你的数据通道是 SSE（text/event-stream），同时增加如下 map：
  # map $http_accept $backend_sse {
  #   default                 "";
  #   "~*text/event-stream"   "127.0.0.1:9001";
  # }

  server {
    # 仅本机监听；frpc 将 remote_port=19002 转发至本机 9100
    listen 127.0.0.1:9100;

    # 单 location，根据 header 动态选择后端
    location / {
      proxy_http_version 1.1;

      # 透传/设置必要头
      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        $connection_upgrade;
      proxy_set_header Host              $host;               # 如 data 严格要求，可改为: $proxy_host
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto http;

      # WebSocket 支持（Upgrade/Connection）
      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        $connection_upgrade;

      # 长连接与低延迟调优
      proxy_connect_timeout   3s;       # 快速失败
      proxy_read_timeout      3600s;    # 支持长连接/流式
      proxy_send_timeout      3600s;
      proxy_request_buffering off;
      proxy_buffering         off;
      proxy_cache             off;

      # 后端选择：优先按 WS upgrade 走 9001，否则走 9002
      proxy_pass http://$backend;

      # 若需兼容 SSE，同时将 proxy_pass 切为变量合成（优先 sse）：
      # set $dst $backend;
      # if ($backend_sse != "") { set $dst $backend_sse; }
      # proxy_pass http://$dst;
    }
  }
}